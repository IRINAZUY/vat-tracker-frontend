<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Firestore Connection Debug</h1>
    <button onclick="testFirestore()">Test Firestore Connection</button>
    <button onclick="clearLogs()">Clear Logs</button>
    <div id="logs"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC7Q5Ffw_vUqt6RZ2beYJBYpYDjGyIXuD0",
            authDomain: "vat-tracker-uae.firebaseapp.com",
            projectId: "vat-tracker-uae",
            storageBucket: "vat-tracker-uae.appspot.com",
            messagingSenderId: "788842579308",
            appId: "1:788842579308:web:77c20cdef9ffa75364df49"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
        }

        window.testFirestore = async function() {
            log('ðŸ” Starting Firestore connection test...', 'info');
            
            try {
                // Check authentication status
                const user = auth.currentUser;
                if (!user) {
                    log('âŒ User not authenticated. Please log in first.', 'error');
                    
                    // Try to sign in with test credentials
                    const email = prompt('Enter email for testing:');
                    const password = prompt('Enter password for testing:');
                    
                    if (email && password) {
                        try {
                            await signInWithEmailAndPassword(auth, email, password);
                            log('âœ… Successfully signed in', 'success');
                        } catch (error) {
                            log(`âŒ Sign in failed: ${error.message}`, 'error');
                            return;
                        }
                    } else {
                        return;
                    }
                }
                
                log(`âœ… Authenticated as: ${auth.currentUser.email}`, 'success');
                log(`ðŸ”‘ User UID: ${auth.currentUser.uid}`, 'info');
                
                // Test 1: Read users collection
                log('ðŸ“– Testing users collection read...', 'info');
                try {
                    const usersRef = collection(db, 'users');
                    const usersSnapshot = await getDocs(usersRef);
                    log(`âœ… Users collection read successful: ${usersSnapshot.docs.length} documents`, 'success');
                    
                    usersSnapshot.docs.forEach((doc, index) => {
                        log(`User ${index + 1}: ${doc.id} - ${JSON.stringify(doc.data())}`, 'info');
                    });
                } catch (error) {
                    log(`âŒ Users collection read failed: ${error.code} - ${error.message}`, 'error');
                    log(`Error details: ${JSON.stringify(error, Object.getOwnPropertyNames(error))}`, 'error');
                }
                
                // Test 2: Read licenses collection
                log('ðŸ“– Testing licenses collection read...', 'info');
                try {
                    const licensesRef = collection(db, 'licenses');
                    const licensesSnapshot = await getDocs(licensesRef);
                    log(`âœ… Licenses collection read successful: ${licensesSnapshot.docs.length} documents`, 'success');
                    
                    licensesSnapshot.docs.forEach((doc, index) => {
                        log(`License ${index + 1}: ${doc.id} - Company: ${doc.data().companyName}`, 'info');
                    });
                } catch (error) {
                    log(`âŒ Licenses collection read failed: ${error.code} - ${error.message}`, 'error');
                    log(`Error details: ${JSON.stringify(error, Object.getOwnPropertyNames(error))}`, 'error');
                }
                
                // Test 3: Write to licenses collection
                log('âœï¸ Testing licenses collection write...', 'info');
                try {
                    const licensesRef = collection(db, 'licenses');
                    const testDoc = await addDoc(licensesRef, {
                        companyName: 'TEST COMPANY - DEBUG',
                        licenseNumber: 'DEBUG123',
                        licenseType: 'Debug Test License',
                        issueDate: new Date(),
                        expiryDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),
                        redZoneDate: new Date(),
                        yellowZoneDate: new Date(),
                        status: 'DEBUG_TEST',
                        createdBy: auth.currentUser.uid,
                        isTest: true,
                        debugTimestamp: new Date().toISOString()
                    });
                    log(`âœ… Test license added successfully with ID: ${testDoc.id}`, 'success');
                    
                    // Clean up test document
                    await deleteDoc(doc(db, 'licenses', testDoc.id));
                    log('âœ… Test license cleaned up', 'success');
                    
                } catch (error) {
                    log(`âŒ Licenses collection write failed: ${error.code} - ${error.message}`, 'error');
                    log(`Error details: ${JSON.stringify(error, Object.getOwnPropertyNames(error))}`, 'error');
                }
                
                log('ðŸ Firestore connection test completed', 'success');
                
            } catch (error) {
                log(`âŒ General error during Firestore test: ${error.message}`, 'error');
                log(`Error details: ${JSON.stringify(error, Object.getOwnPropertyNames(error))}`, 'error');
            }
        }
        
        // Auto-run test when page loads
        window.addEventListener('load', () => {
            log('ðŸš€ Firestore debug page loaded. Click "Test Firestore Connection" to start.', 'info');
        });
    </script>
</body>
</html>